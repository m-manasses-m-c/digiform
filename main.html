<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<title>Questionário 4 Áreas → 46 Perfis (com histórico + Digimon)</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  :root{
    --bg:#0f172a; --panel:#111827; --muted:#94a3b8; --text:#e5e7eb; --accent:#06b6d4;
    --good:#22c55e; --bad:#ef4444; --warn:#f59e0b; --neutral:#64748b;
  }
  body{font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text);margin:0;line-height:1.45}
  header{padding:24px 16px;background:linear-gradient(90deg,#0ea5e9,#7c3aed);color:white}
  header h1{margin:0 0 8px;font-size:22px}
  header p{margin:0;opacity:.9}
  main{max-width:1100px;margin:24px auto;padding:0 16px}
  .card{background:var(--panel);border:1px solid #1f2937;border-radius:12px;margin:16px 0;overflow:hidden}
  .card h2{margin:0;padding:14px 16px;border-bottom:1px solid #1f2937;font-size:18px;background:#0b1220}
  .card .body{padding:12px 16px}
  .q{margin:12px 0;padding:8px 10px;border:1px solid #1f2937;border-radius:10px}
  .q label{display:block;margin-bottom:8px;font-weight:600}
  .likert{display:grid;grid-template-columns:60px 1fr 60px;gap:10px;align-items:center}
  .likert .scale{display:flex;gap:6px;align-items:center}
  .likert input[type=range]{width:100%}
  .hint{color:var(--muted);font-size:12px;margin-top:2px}
  .actions{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0 16px}
  button{background:linear-gradient(180deg,#0ea5e9,#2563eb);border:none;color:white;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:700}
  button.secondary{background:#334155}
  button.ghost{background:transparent;border:1px solid #334155;color:#cbd5e1}
  .grid{display:grid;gap:12px}
  @media(min-width:900px){ .grid.cols-2{grid-template-columns:1fr 1fr} .grid.cols-3{grid-template-columns:1fr 1fr 1fr} }
  .meter{height:18px;background:#0b1220;border:1px solid #1f2937;border-radius:999px;position:relative;overflow:hidden}
  .meter .fill{height:100%;background:linear-gradient(90deg,#22c55e,#06b6d4);width:0%}
  .meter .center{position:absolute;left:50%;top:0;bottom:0;width:2px;background:#1f2937;opacity:.8}
  .row{display:flex;justify-content:space-between;gap:8px;align-items:center}
  .tag{display:inline-block;background:#0b1220;border:1px solid #1f2937;border-radius:999px;padding:2px 8px;margin-right:6px;font-size:12px;color:#cbd5e1}
  .muted{color:var(--muted)}
  .result-title{font-size:22px;margin:6px 0}
  .desc{color:#d1d5db}
  .small{font-size:12px;color:#9ca3af}
  footer{padding:16px;color:#94a3b8;text-align:center}
  ul.tight{margin:8px 0 0 18px;padding:0}
  ul.tight li{margin:4px 0}
  details summary{cursor:pointer}
  .axis-card{padding:8px 10px;border:1px solid #1f2937;border-radius:10px}
  .axis-title{font-weight:700}
  .axis-sub{color:#9ca3af;font-size:12px;margin-top:2px}
  .digimon-badge{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;border:1px solid #334155;background:#0b1220}

  /* Tema claro opcional */
html[data-theme="light"]{
  --bg:#f8fafc; --panel:#ffffff; --text:#0f172a; --muted:#64748b; --accent:#0ea5e9;
}
html[data-theme="light"] header{
  color:#0f172a;
  background:linear-gradient(90deg,#93c5fd,#a78bfa);
}
html[data-theme="light"] .card h2{ background:#f1f5f9 }
html[data-theme="light"] .meter{ background:#f8fafc; border-color:#e5e7eb }
html[data-theme="light"] .axis-card{ border-color:#e5e7eb }
html[data-theme="light"] .tag{ background:#f8fafc; border-color:#e5e7eb; color:#334155 }
html[data-theme="light"] button.secondary{ background:#e2e8f0; color:#0f172a }
html[data-theme="light"] button.ghost{ border-color:#cbd5e1; color:#334155 }
html[data-theme="light"] .digimon-badge{ background:#f8fafc; border-color:#e5e7eb }

/* Acessibilidade e foco */
:focus-visible{ outline:3px solid var(--accent); outline-offset:2px; border-radius:8px }

/* Header: barra de progresso */
.header-progress{
  margin-top:10px; height:8px; background:#0b1220; border:1px solid #1f2937;
  border-radius:999px; overflow:hidden; position:relative
}
html[data-theme="light"] .header-progress{ background:#eef2ff; border-color:#e5e7eb }
.header-progress .fill{ height:100%; width:0%; background:linear-gradient(90deg,#06b6d4,#22c55e); transition:width .25s ease }

/* Cards das seções: colapsáveis e ações no título */
#questions .card h2{
  display:flex; align-items:center; justify-content:space-between; gap:8px; cursor:pointer
}
.section-tools{ display:flex; gap:8px; align-items:center }
.section-tools .mini{ font-size:12px; opacity:.8 }
.section-tools .chip{ background:#0b1220; border:1px solid #1f2937; border-radius:999px; padding:2px 8px; font-size:12px }
.card.collapsed .body{ display:none }
.chev{ transition:transform .2s ease; opacity:.7 }
.card.collapsed .chev{ transform:rotate(-90deg) }

/* Slider mais legível, com marcas e bolha */
.likert .scale{ position:relative; width:100% }
.q input[type=range]{
  -webkit-appearance:none; width:100%; height:6px; background:transparent; cursor:pointer
}
.q input[type=range]::-webkit-slider-runnable-track{
  height:6px; border-radius:999px; background:
    linear-gradient(90deg,transparent 0, transparent 2%, #1f2937 2%, #1f2937 3%, transparent 3%),
    linear-gradient(90deg,#0b1220,#0b1220);
  border:1px solid #1f2937;
}
.q input[type=range]::-webkit-slider-thumb{
  -webkit-appearance:none; height:18px; width:18px; border-radius:50%;
  background:linear-gradient(180deg,#22c55e,#06b6d4); border:2px solid #0b1220; margin-top:-7px
}
.q input[type=range]::-moz-range-track{
  height:6px; border-radius:999px; background:#0b1220; border:1px solid #1f2937
}
.q input[type=range]::-moz-range-thumb{
  height:18px; width:18px; border-radius:50%;
  background:linear-gradient(180deg,#22c55e,#06b6d4); border:2px solid #0b1220
}
.value-bubble{
  position:absolute; top:-28px; transform:translateX(-50%);
  background:#111827; color:#e5e7eb; border:1px solid #1f2937; padding:2px 6px; font-size:12px; border-radius:6px;
  pointer-events:none; white-space:nowrap
}
html[data-theme="light"] .value-bubble{ background:#ffffff; color:#0f172a; border-color:#e5e7eb }

/* Sticky bar de ações */
#stickyBar{
  position:fixed; left:0; right:0; bottom:0; z-index:50; backdrop-filter: blur(6px);
  background:rgba(15,23,42,.75); border-top:1px solid #1f2937; padding:8px 12px
}
html[data-theme="light"] #stickyBar{ background:rgba(255,255,255,.85); border-top-color:#e5e7eb }
#stickyBar .wrap{ max-width:1100px; margin:0 auto; display:flex; gap:8px; align-items:center; justify-content:space-between; flex-wrap:wrap }
#stickyBar .left, #stickyBar .right{ display:flex; gap:8px; align-items:center }
#stickyBar .hint{ font-size:12px; color:var(--muted) }

/* Destaque ao pular para pergunta */
.pulse{ animation:pulse 1s ease; }
@keyframes pulse{
  0%{ box-shadow:0 0 0 0 rgba(14,165,233,.6) }
  100%{ box-shadow:0 0 0 8px rgba(14,165,233,0) }
}
</style>
</head>
<body>
<header>
  <h1>Questionário amplo: Ideologia • Política • Personalidade • Filosofia</h1>
  <p>Responda 48 afirmações (1–5). O script calcula automaticamente e classifica você em 1 de 46 perfis, salva histórico e sugere um Digimon correspondente.</p>
</header>

<main>
  <div class="card">
    <h2>Instruções</h2>
    <div class="body">
      <ul>
        <li>Escala 1–5: 1 = Discordo totalmente; 3 = Neutro; 5 = Concordo totalmente.</li>
        <li>Todas as questões começam em “3” (neutro). Ajuste conforme sua visão.</li>
        <li>Clique “Calcular meu perfil”. Você verá os eixos normalizados, o perfil, as correntes filosóficas e o Digimon correspondente.</li>
      </ul>
      <div class="actions">
        <button id="btnRandom">Aleatorizar respostas</button>
        <button class="secondary" id="btnNeutral">Resetar para Neutro (3)</button>
        <label class="tag" style="cursor:pointer">
          <input type="checkbox" id="chkAutoSave" style="vertical-align:middle;margin-right:6px"> Salvar automaticamente cada cálculo
        </label>
      </div>
      <div class="small">Auto-save: ativado por padrão. Os registros ficam no seu navegador (localStorage).</div>
    </div>
  </div>

  <form id="quizForm">
    <div id="questions"></div>
    <div class="card">
      <div class="body">
        <div class="actions">
          <button type="button" id="btnCalc">Calcular meu perfil</button>
          <button type="button" class="ghost" id="btnExport">Exportar resultado (JSON)</button>
        </div>
        <div class="small">Privacidade: tudo acontece no seu navegador (sem envio a servidores).</div>
      </div>
    </div>
  </form>

  <div id="results" class="card" style="display:none">
    <h2>Resultados</h2>
    <div class="body">
      <div id="profileBlock"></div>
      <div class="actions">
        <button type="button" id="btnSaveHistory">Salvar no histórico</button>
      </div>
      <hr style="border-color:#1f2937;margin:16px 0">
      <h3>Eixos (normalizados)</h3>
      <div id="axesGrid" class="grid cols-2"></div>
      <hr style="border-color:#1f2937;margin:16px 0">
      <h3>Top 3 correntes filosóficas</h3>
      <div id="topCurrents" class="grid cols-3"></div>
      <details style="margin-top:12px">
        <summary>Ver todas as correntes</summary>
        <div id="allCurrents" class="grid cols-3" style="margin-top:8px"></div>
      </details>
    </div>
  </div>

  <div id="historyCard" class="card">
    <h2>Histórico de resultados</h2>
    <div class="body">
      <div class="actions">
        <button type="button" class="ghost" id="btnExportHistory">Exportar histórico (JSON)</button>
        <button type="button" class="secondary" id="btnClearHistory">Limpar histórico</button>
      </div>
      <div id="historyList" class="grid cols-2"></div>
      <div id="historyEmpty" class="small" style="display:none">Sem registros ainda. Calcule um perfil e clique “Salvar no histórico”.</div>
    </div>
  </div>

  <div id="debug" class="card" style="display:none">
    <h2>Debug</h2>
    <div class="body">
      <pre id="debugPre" style="white-space:pre-wrap"></pre>
    </div>
  </div>
</main>

<script>
/*
  Atualizações:
  - Agora são 48 enunciados: 12 por seção (Ideologia, Política, Personalidade e Filosofia).
  - Título e subtítulo em cada eixo normalizado.
  - Auto-save ativado por padrão.
  - Digimon para cada um dos 46 perfis com justificativa.
*/

/* ----------------------------- Data: Items ----------------------------- */
const items = [
  // Ideologia (I1..I12)
  {code:'I1', group:'Ideologia', text:'Diante de duas reformas, prefiro a que diminui disparidades entre grupos mesmo que o avanço produtivo seja mais lento.', type:'dir',
    axes:{Ecom:10, Cult:4}, currents:{}},
  {code:'I2', group:'Ideologia', text:'Autoridades só devem limitar escolhas pessoais quando houver dano concreto a terceiros.', type:'dir',
    axes:{Autor:12, Ecom:-4}, currents:{}},
  {code:'I3', group:'Ideologia', text:'Costumes herdados e liderança espiritual oferecem uma moldura moral mais confiável que experimentos sociais.', type:'dir',
    axes:{Cult:-10, Orto:12, Etica:6}, currents:{DE:8, OR:10}},
  {code:'I4', group:'Ideologia', text:'Expressões culturais novas devem ser incorporadas rapidamente, sem esperar consenso prolongado.', type:'dir',
    axes:{Cult:10}, currents:{}},
  {code:'I5', group:'Ideologia', text:'A distribuição de oportunidades deve refletir desempenho e esforço mais do que origem ou contexto.', type:'dir',
    axes:{Ecom:-10}, currents:{}},
  {code:'I6', group:'Ideologia', text:'Normas comuns precisam acomodar estilos de vida minoritários sem exigir justificativas extras.', type:'dir',
    axes:{Cult:10}, currents:{}},
  {code:'I7', group:'Ideologia', text:'Prefiro soluções com liberdade de escolha e competição a arranjos únicos conduzidos centralmente.', type:'dir',
    axes:{Ecom:-12, Autor:6}, currents:{}},
  {code:'I8', group:'Ideologia', text:'Quando um grupo precisa decidir, valorizo arranjos de cuidado mútuo mesmo que reduzam graus de autonomia individual.', type:'uni',
    axes:{Ecom:10, Virt:6}, currents:{VI:6}},
  {code:'I9', group:'Ideologia', text:'Algumas ações são simplesmente erradas, independentemente de seus resultados.', type:'dir',
    axes:{Etica:12}, currents:{DE:10}},
  {code:'I10', group:'Ideologia', text:'Considero civilizado garantir um piso de dignidade financiado coletivamente, ainda que custe caro.', type:'dir',
    axes:{Ecom:12}, currents:{}},
  {code:'I11', group:'Ideologia', text:'Regras fortes de propriedade e de contrato são a melhor defesa contra abusos, inclusive do poder público.', type:'dir',
    axes:{Ecom:-12, Autor:6}, currents:{}},
  {code:'I12', group:'Ideologia', text:'Vejo valor em resguardar hábitos locais e expressões nacionais contra pressões uniformizantes globais.', type:'dir',
    axes:{Cult:-12, Glob:-8}, currents:{}},

  // Política (P1..P12)
  {code:'P1', group:'Política', text:'Quem mais se beneficia do sistema deve contribuir proporcionalmente mais para financiá-lo.', type:'dir',
    axes:{Ecom:12}, currents:{}},
  {code:'P2', group:'Política', text:'Em setores de alto risco, prefiro limites firmes definidos pelo regulador, mesmo que restrinjam escolhas.', type:'dir',
    axes:{Autor:-10}, currents:{}},
  {code:'P3', group:'Política', text:'Áreas críticas (energia, defesa, infraestrutura) devem ter direção pública predominante para evitar vulnerabilidades.', type:'dir',
    axes:{Ecom:12}, currents:{}},
  {code:'P4', group:'Política', text:'Direitos individuais básicos não devem ser sacrificados por preferências momentâneas da maioria.', type:'dir',
    axes:{Autor:12}, currents:{}},
  {code:'P5', group:'Política', text:'Quando um acordo internacional contraria interesses domésticos essenciais, o país deve priorizar sua autonomia.', type:'dir',
    axes:{Glob:-12}, currents:{}},
  {code:'P6', group:'Política', text:'Mistura cultural e chegada de imigrantes tendem a fortalecer o país no longo prazo.', type:'dir',
    axes:{Glob:12, Cult:6}, currents:{}},
  {code:'P7', group:'Política', text:'Para manter a ordem, aceito ampliar monitoramento e presença policial.', type:'dir',
    axes:{Autor:-10}, currents:{}},
  {code:'P8', group:'Política', text:'É razoável trocar parte do crescimento presente por metas ambientais vinculantes.', type:'dir',
    axes:{Ecom:10, Cult:6}, currents:{}},
  {code:'P9', group:'Política', text:'Em casos extremos, é legítimo intervir além das fronteiras para proteger vidas e liberdades.', type:'dir',
    axes:{Glob:12}, currents:{}},
  {code:'P10', group:'Política', text:'Obrigatoriedade de voto ajuda a legitimar decisões coletivas.', type:'dir',
    axes:{Autor:-8}, currents:{}},
  {code:'P11', group:'Política', text:'Regras fiscais rígidas devem limitar governantes, mesmo em momentos populares.', type:'dir',
    axes:{Ecom:-8}, currents:{}},
  {code:'P12', group:'Política', text:'Medidas temporárias que mudam a competição podem ser justas para corrigir desvantagens históricas.', type:'dir',
    axes:{Cult:12, Ecom:6}, currents:{}},

  // Personalidade (N1..N12)
  {code:'N1', group:'Personalidade', text:'Eu me animo explorando ideias incomuns e ligações pouco óbvias.', type:'uni',
    axes:{O:8}, currents:{}},
  {code:'N2', group:'Personalidade', text:'Transformo planos em listas e cumpro o que prometo.', type:'uni',
    axes:{C:8}, currents:{}},
  {code:'N3', group:'Personalidade', text:'Eventos cheios de gente me reabastecem de energia.', type:'uni',
    axes:{E:8}, currents:{}},
  {code:'N4', group:'Personalidade', text:'Quando há conflito, busco pontes antes de posições.', type:'uni',
    axes:{A:8}, currents:{}},
  {code:'N5', group:'Personalidade', text:'Sob pressão, mantenho a cabeça fria e me recomponho rápido.', type:'uni',
    axes:{S:8}, currents:{}},
  {code:'N6', group:'Personalidade', text:'Sou atraído(a) por estética, texturas e experiências fora do comum.', type:'uni',
    axes:{O:8}, currents:{}},
  {code:'N7', group:'Personalidade', text:'Rotinas e preparação antecipada me deixam à vontade.', type:'uni',
    axes:{C:8}, currents:{}},
  {code:'N8', group:'Personalidade', text:'Em grupos, costumo puxar a conversa e organizar o andamento.', type:'uni',
    axes:{E:8}, currents:{}},
  {code:'N9', group:'Personalidade', text:'Considero com atenção como os outros se sentem antes de decidir.', type:'uni',
    axes:{A:8}, currents:{}},
  {code:'N10', group:'Personalidade', text:'Não desisto de metas demoradas; volto a elas até concluir.', type:'uni',
    axes:{C:8}, currents:{}},
  {code:'N11', group:'Personalidade', text:'Tenho curiosidade por lugares, sabores e tradições que não conheço.', type:'uni',
    axes:{O:8}, currents:{}},
  {code:'N12', group:'Personalidade', text:'Falar para muitas pessoas me anima mais do que me aflige.', type:'uni',
    axes:{E:8}, currents:{}},

  // Filosofia (F1..F12)
  {code:'F1', group:'Filosofia', text:'Sem teste e observação, mantenho ceticismo; medições pesam mais que intuições.', type:'dir',
    axes:{Epist:-12}, currents:{EM:12, MA:6}},
  {code:'F2', group:'Filosofia', text:'Algumas regras morais valem sempre, ainda quando seria conveniente ignorá-las.', type:'dir',
    axes:{Etica:12}, currents:{DE:12}},
  {code:'F3', group:'Filosofia', text:'Aceito abrir exceções a regras se isso elevar substancialmente o bem-estar de mais gente.', type:'dir',
    axes:{Etica:-12}, currents:{UT:12}},
  {code:'F4', group:'Filosofia', text:'Cultivar caráter e hábitos virtuosos é mais importante do que apenas perseguir resultados.', type:'uni',
    axes:{Virt:10}, currents:{VI:12}},
  {code:'F5', group:'Filosofia', text:'Princípios e estruturas imateriais explicam o mundo de modo mais profundo que as aparências.', type:'dir',
    axes:{Epist:10}, currents:{PL:12, RA:8}},
  {code:'F6', group:'Filosofia', text:'Mente e consciência surgem de processos físicos; não vejo algo além da matéria.', type:'dir',
    axes:{Epist:-8, Orto:-8}, currents:{MA:12}},
  {code:'F7', group:'Filosofia', text:'Liberdade vem junto com angústia e tarefa de construir sentido.', type:'uni',
    axes:{}, currents:{EX:12}},
  {code:'F8', group:'Filosofia', text:'Na dúvida séria, prefiro suspender o juízo a apostar sem base.', type:'uni',
    axes:{}, currents:{CE:12}},
  {code:'F9', group:'Filosofia', text:'Identifico-me com uma fé sacramental, trinitária e enraizada na tradição viva.', type:'dir',
    axes:{Orto:14}, currents:{OR:14}},
  {code:'F10', group:'Filosofia', text:'Domínio de si e serenidade diante do incontrolável são virtudes centrais para mim.', type:'uni',
    axes:{Virt:8, S:4}, currents:{ES:12}},
  {code:'F11', group:'Filosofia', text:'Vejo a comunidade de fé como um hospital da alma; o mistério se expressa melhor em silêncio que em fórmulas.', type:'dir',
    axes:{Orto:12}, currents:{OR:12}},
  {code:'F12', group:'Filosofia', text:'Dou prioridade à experiência vivida bem descrita antes de teorizar sobre ela.', type:'uni',
    axes:{}, currents:{FE:12}},
];

/* -------------------- Render: Questions (range 1..5) ------------------- */
const groupsOrder = ['Ideologia','Política','Personalidade','Filosofia'];
const questionsContainer = document.getElementById('questions');

function renderQuestions(){
  const byGroup = {};
  for(const g of groupsOrder){ byGroup[g] = []; }
  for(const it of items){ if(!byGroup[it.group]) byGroup[it.group]=[]; byGroup[it.group].push(it); }
  const frag = document.createDocumentFragment();
  for(const g of groupsOrder){
    const card = document.createElement('div');
    card.className='card';
    const h2 = document.createElement('h2');
    h2.textContent = g;
    const body = document.createElement('div'); body.className='body';
    for(const it of byGroup[g]){
      const div = document.createElement('div'); div.className='q';
      const label = document.createElement('label');
      label.setAttribute('for', it.code);
      label.textContent = `${it.code}. ${it.text}`;
      const likert = document.createElement('div'); likert.className='likert';
      const left = document.createElement('div'); left.className='muted'; left.textContent='Discordo';
      const right = document.createElement('div'); right.className='muted'; right.textContent='Concordo';
      const scale = document.createElement('div'); scale.className='scale';
      const input = document.createElement('input');
      input.type='range'; input.min='1'; input.max='5'; input.step='1'; input.value='3'; input.id=it.code; input.name=it.code;
      scale.appendChild(input);
      const hint = document.createElement('div'); hint.className='hint'; hint.textContent='1  2  3  4  5';
      likert.append(left, scale, right);
      div.append(label, likert, hint);
      body.appendChild(div);
    }
    card.append(h2, body);
    frag.appendChild(card);
  }
  questionsContainer.innerHTML='';
  questionsContainer.appendChild(frag);
}
renderQuestions();

/* ----------------------- Scoring: Axes & Currents ---------------------- */
const axisNames = ['Ecom','Cult','Autor','Glob','Epist','Etica','Virt','Orto','O','C','E','A','S'];
const axisMeta = {
  Ecom:{type:'dir', title:'Economia', desc:'Estado (+) ↔ Mercado (−)'},
  Cult:{type:'dir', title:'Cultura', desc:'Progressista (+) ↔ Tradicionalista (−)'},
  Autor:{type:'dir', title:'Autoridade', desc:'Libertário (+) ↔ Autoritário (−)'},
  Glob:{type:'dir', title:'Globalismo', desc:'Cosmopolita (+) ↔ Nacionalista (−)'},
  Epist:{type:'dir', title:'Epistemologia', desc:'Racionalismo (+) ↔ Empirismo (−)'},
  Etica:{type:'dir', title:'Ética', desc:'Deontologia (+) ↔ Consequencialismo (−)'},
  Virt:{type:'uni', title:'Virtudes', desc:'Ênfase na ética das virtudes (0→100)'},
  Orto:{type:'dir', title:'Tradição Sacramental', desc:'Enraizamento litúrgico/comunitário (+) ↔ Naturalismo secular (−)'},
  O:{type:'uni', title:'Abertura', desc:'Big Five: abertura a experiências (0→100)'},
  C:{type:'uni', title:'Conscienciosidade', desc:'Big Five: organização e disciplina (0→100)'},
  E:{type:'uni', title:'Extroversão', desc:'Big Five: energia social (0→100)'},
  A:{type:'uni', title:'Amabilidade', desc:'Big Five: cooperação e empatia (0→100)'},
  S:{type:'uni', title:'Estabilidade Emocional', desc:'Big Five: resiliência (0→100)'},
};

const currentsList = ['EM','RA','UT','DE','VI','EX','ES','CE','PL','MA','FE','OR'];
const currentsMeta = {
  EM:'Empirismo',
  RA:'Racionalismo',
  UT:'Utilitarismo (Consequencialismo)',
  DE:'Deontologia (Kantismo)',
  VI:'Ética das Virtudes (Aristotelismo)',
  EX:'Existencialismo',
  ES:'Estoicismo',
  CE:'Ceticismo',
  PL:'Platonismo',
  MA:'Materialismo',
  FE:'Fenomenologia',
  OR:'Cristianismo Ortodoxo'
};

// Max ranges for normalization
const axisMax = {};
const currentsMax = {};
function computeMaxima(){
  for(const a of axisNames){ axisMax[a] = {sumAbs:0, uniMax:0}; }
  for(const c of currentsList){ currentsMax[c] = 0; }
  for(const it of items){
    for(const [a,k] of Object.entries(it.axes||{})){
      if(axisMeta[a].type==='dir'){ axisMax[a].sumAbs += 2*Math.abs(k); }
      else{ axisMax[a].uniMax += 4*k; }
    }
    for(const [c,k] of Object.entries(it.currents||{})){
      currentsMax[c] += 4*k;
    }
  }
}
computeMaxima();

function getResponses(){
  const vals = {};
  for(const it of items){
    const el = document.getElementById(it.code);
    vals[it.code] = parseInt(el.value || '3', 10);
  }
  return vals;
}

function computeScores(responses){
  const rawAxes = Object.fromEntries(axisNames.map(a=>[a,0]));
  const rawCurr = Object.fromEntries(currentsList.map(c=>[c,0]));
  for(const it of items){
    const r = responses[it.code];
    const d = (r - 3); // −2..+2
    const u = (r - 1); // 0..4
    for(const [a,k] of Object.entries(it.axes||{})){
      if(axisMeta[a].type==='dir'){ rawAxes[a] += d*k; }
      else{ rawAxes[a] += u*k; }
    }
    for(const [c,k] of Object.entries(it.currents||{})){
      rawCurr[c] += u*k;
    }
  }
  const axesNorm = {};
  for(const a of axisNames){
    if(axisMeta[a].type==='dir'){
      const denom = axisMax[a].sumAbs || 1;
      axesNorm[a] = clamp((rawAxes[a]/denom)*100, -100, 100);
    }else{
      const denom = axisMax[a].uniMax || 1;
      axesNorm[a] = clamp((rawAxes[a]/denom)*100, 0, 100);
    }
  }
  const currNorm = {};
  for(const c of currentsList){
    const denom = currentsMax[c] || 1;
    currNorm[c] = clamp((rawCurr[c]/denom)*100, 0, 100);
  }
  return {rawAxes, axesNorm, rawCurr, currNorm};
}
function clamp(x, lo, hi){ return Math.max(lo, Math.min(hi, x)); }

/* ------------------ Profiles (23 bases × 2, com explicações) ---------- */
const baseProfiles = [
  {code:'B1', name:'Liberal Cosmopolita de Mercado', vec:{Ecom:-70, Cult:50, Autor:70, Glob:70, Orto:-60, O:70, C:55, E:60, A:60, S:60},
    descP:'Liberal clássico de direitos naturais; pró-mercado, progressista em costumes, libertário e pró-integração global.',
    descG:'Liberal pró-mercado orientado a resultados: regulações quando eficazes e políticas baseadas em evidências.',
    expP:[
      'Eixos: mercado forte (−Ecom), costumes progressistas (+Cult), liberdades civis (+Autor), cosmopolitismo (+Glob).',
      'Filosofia: deontologia e racionalismo; direitos como princípios e igualdade perante a lei.',
      'Políticas: livre-comércio, regulação pró-competição, igualdade civil, migração e inovação.'
    ],
    expG:[
      'Mesmos eixos com foco consequencialista e empirista.',
      'Critério: impacto mensurável no bem-estar e na competição.',
      'Ferramentas: precificação de externalidades, vouchers/testes A/B, avaliação de políticas.'
    ]},
  {code:'B2', name:'Libertário Localista', vec:{Ecom:-80, Cult:20, Autor:80, Glob:-20, Orto:-40, O:65, C:55, E:55, A:65, S:60},
    descP:'Autonomia individual com ênfase em comunidades locais e subsidiariedade. Não agressão e direitos naturais.',
    descG:'Soluções voluntárias de proximidade; experimentação cívica e empirismo local.',
    expP:[
      'Eixos: mercado (−Ecom), libertário (+Autor), localista (Glob levemente −), cultura moderada (+Cult).',
      'Filosofia: princípio de não agressão, subsidiariedade, confiança em instituições locais.',
      'Políticas: descentralização, escolas/saúde com liberdade de escolha, cooperativas e mutualismo.'
    ],
    expG:[
      'Foco no que funciona no município/bairro.',
      'Pilotos e métricas locais, regulação leve, arranjos voluntários.',
      'Mercados com governança comunitária e reputação.'
    ]},
  {code:'B3', name:'Capitalista Social Progressista', vec:{Ecom:-40, Cult:70, Autor:60, Glob:60, Orto:-40, O:75, C:60, E:60, A:65, S:60},
    descP:'Pró-inovação, mercado com redes de proteção, costumes progressistas. Dignidade, direitos e deveres cívicos.',
    descG:'Pragmatismo regulatório calibrado por dados, impacto e custo-efetividade.',
    expP:[
      'Eixos: mercado moderado (−Ecom) com proteção social, progressismo (+Cult), liberdades (+Autor), cosmopolitismo (+Glob).',
      'Filosofia: princípios de dignidade e justiça aliado à inovação.',
      'Políticas: renda mínima/seguro social, competição e direitos civis fortes.'
    ],
    expG:[
      'Ajusta a regulação pelo que prova funcionar.',
      'Mede externalidades e incentiva inovação sustentável.',
      'Expansões sociais via pilotos e avaliação de impacto.'
    ]},
  {code:'B4', name:'Social-Democrata Cosmopolita', vec:{Ecom:30, Cult:70, Autor:40, Glob:70, Orto:-30, O:70, C:60, E:55, A:70, S:55},
    descP:'Bem-estar robusto, progressismo cultural, integração internacional. Justiça e igualdade como deveres públicos.',
    descG:'Equilíbrio entre impostos, serviços e crescimento; políticas testadas e ajustáveis.',
    expP:[
      'Eixos: Estado (+Ecom), progressismo (+Cult), liberdades (+Autor), cosmopolitismo (+Glob).',
      'Filosofia: deveres de justiça, universalismo de direitos.',
      'Políticas: saúde/educação universais, proteção ao trabalho, cooperação internacional.'
    ],
    expG:[
      'Benchmarks nórdicos e metas claras.',
      'Foco em sustentabilidade fiscal e indicadores sociais.',
      'Correções iterativas conforme resultados.'
    ]},
  {code:'B5', name:'Nacional-Desenvolvimentista S-D', vec:{Ecom:50, Cult:30, Autor:10, Glob:-40, Orto:-10, O:55, C:65, E:50, A:60, S:60},
    descP:'Planejamento estatal e projeto nacional; valores comunitários moderados.',
    descG:'Busca resultados industriais e de renda com pragmatismo estratégico.',
    expP:[
      'Eixos: Estado (+Ecom), cultura moderada (+Cult), nacionalismo (−Glob).',
      'Filosofia: bem comum, deveres cívicos e coesão.',
      'Políticas: conteúdo local, crédito direcionado, compras públicas estratégicas.'
    ],
    expG:[
      'Análises de cadeia produtiva e metas exportadoras.',
      'Clústeres e parques tecnológicos com governança por desempenho.',
      'Revisões periódicas de incentivos.'
    ]},
  {code:'B6', name:'Socialista Dem. Municipalista', vec:{Ecom:70, Cult:60, Autor:40, Glob:-10, Orto:-20, O:65, C:55, E:50, A:70, S:55},
    descP:'Democracia econômica local, cooperativas e igualdade. Solidariedade e participação.',
    descG:'Experimentos municipais e métricas de bem-estar.',
    expP:[
      'Eixos: Estado (+Ecom), progressismo (+Cult), autonomia cívica (+Autor), localismo leve (Glob ≈ 0/−).',
      'Filosofia: participação deliberativa e justiça distributiva.',
      'Políticas: orçamentos participativos, cooperativas e conselhos comunitários.'
    ],
    expG:[
      'Pilotos de bairro com indicadores de saúde e educação.',
      'Escalonamento do que funciona, transparência radical.',
      'Plataformas públicas digitais para participação.'
    ]},
  {code:'B7', name:'Eco-Liberal', vec:{Ecom:-30, Cult:80, Autor:50, Glob:60, Orto:-30, O:80, C:55, E:55, A:65, S:55},
    descP:'Sustentabilidade com mercados, inovação verde e direitos individuais.',
    descG:'Precificação de externalidades e regulação “smart”.',
    expP:[
      'Eixos: mercado moderado (−Ecom), progressismo (+Cult), liberdades (+Autor), cosmopolitismo (+Glob).',
      'Filosofia: dever intergeracional e prudência científica.',
      'Políticas: mercados de carbono, propriedade ambiental, inovação limpa.'
    ],
    expG:[
      'Design regulatório baseado em evidências.',
      'Pilotos tecnológicos e medição de emissões/impactos.',
      'Revisão ágil e accountability.'
    ]},
  {code:'B8', name:'Eco-Socialista', vec:{Ecom:60, Cult:80, Autor:10, Glob:30, Orto:-20, O:75, C:50, E:50, A:70, S:50},
    descP:'Transição ecológica liderada pelo Estado, justiça climática e igualdade.',
    descG:'Prioriza mitigação/adaptação efetivas com foco em impacto.',
    expP:[
      'Eixos: Estado (+Ecom), progressismo (+Cult), internacionalismo moderado (+Glob).',
      'Filosofia: dever moral ambiental e sobriedade.',
      'Políticas: energia pública verde, tarifas sociais, empregos de transição.'
    ],
    expG:[
      'Indicadores de custo-efetividade climática.',
      'Metas claras de descarbonização e adaptação.',
      'Revisões baseadas em resultados sociais.'
    ]},
  {code:'B9', name:'Conservador Liberal', vec:{Ecom:-50, Cult:-50, Autor:40, Glob:40, Orto:20, O:45, C:65, E:55, A:55, S:60},
    descP:'Tradição e mercado com liberdades civis; cético a rupturas rápidas.',
    descG:'Preserva costumes com flexibilidade orientada a resultados.',
    expP:[
      'Eixos: mercado (−Ecom) e tradicionalismo (−Cult) com liberdades (+Autor).',
      'Filosofia: ordem social, deveres e virtudes cívicas.',
      'Políticas: liberdade religiosa, prudência regulatória, federalismo.'
    ],
    expG:[
      'Avalia reformas por eficácia e custo.',
      'Adapta tradições sem romper instituições.',
      'Regulação enxuta e responsiva.'
    ]},
  {code:'B10', name:'Conservador Comunitarista', vec:{Ecom:10, Cult:-60, Autor:-10, Glob:-20, Orto:40, O:40, C:65, E:50, A:65, S:60},
    descP:'Comunidade, família e deveres; ordem social orgânica.',
    descG:'Política pró-comunidade guiada por resultados.',
    expP:[
      'Eixos: ligeiro estatismo (+Ecom), tradicionalismo (−Cult), localismo (−Glob).',
      'Filosofia: virtudes de caráter e obrigações mútuas.',
      'Políticas: suporte a famílias, associações civis, segurança proporcional.'
    ],
    expG:[
      'Avalia coesão: crime, solidão, capital social.',
      'Programas focados em vínculos locais e mentoria.',
      'Recortes por evidência territorial.'
    ]},
  {code:'B11', name:'Democrata-Cristão (Ort.)', vec:{Ecom:-10, Cult:-20, Autor:30, Glob:10, Orto:70, O:50, C:70, E:50, A:70, S:65},
    descP:'Síntese de valores ortodoxos com democracia e economia social de mercado.',
    descG:'Mesma linha com pragmatismo e avaliação empírica.',
    expP:[
      'Eixos: economia social de mercado, tradicionalismo leve (−Cult), liberdades moderadas (+Autor), Orto alto (+).',
      'Teologia: foco na vontade de Deus e vida sacramental.',
      'Políticas: subsidiariedade, proteção social à família, ética pública.'
    ],
    expG:[
      'Aplicação prudencial de princípios conforme evidência.',
      'Parcerias público-comunitárias.',
      'Foco em frutos sociais e dignidade da pessoa.'
    ]},
  {code:'B12', name:'Tradicionalista Ortodoxo', vec:{Ecom:20, Cult:-80, Autor:-30, Glob:-40, Orto:90, O:40, C:65, E:45, A:70, S:70},
    descP:'Enraizado na Tradição Ortodoxa: liturgia, sacramentos e vida virtuosa.',
    descG:'Mantém ethos ortodoxo com prudência na vida pública.',
    expP:[
      'Eixos: tradicionalismo forte (−Cult), comunitarismo e Orto muito alto (+).',
      'Ênfase na vida eclesial, ascese e theosis.',
      'Políticas: liberdade religiosa, família e solidariedade.'
    ],
    expG:[
      'Prudência e foco em frutos concretos.',
      'Caridade eficaz e cooperação quando oportuno.',
      'Prioriza paz social e cuidado ao próximo.'
    ]},
  {code:'B13', name:'Neoconservador Globalista', vec:{Ecom:-30, Cult:-20, Autor:-10, Glob:80, Orto:20, O:50, C:60, E:55, A:50, S:60},
    descP:'Ordem internacional, comércio e defesa; dever de proteger.',
    descG:'Intervenções e alianças calibradas por custo-benefício.',
    expP:[
      'Eixos: mercado moderado (−Ecom), conservador nos costumes (−Cult), globalista (+Glob).',
      'Filosofia: norma internacional e responsabilidade.',
      'Políticas: alianças, comércio e dissuasão robusta.'
    ],
    expG:[
      'Critérios: estabilidade regional, baixas civis e sustentabilidade.',
      'Limita nation-building ao que é viável.',
      'Avaliações pós-ação e aprendizado institucional.'
    ]},
  {code:'B14', name:'Populista Nacional de Direita', vec:{Ecom:-10, Cult:-70, Autor:-40, Glob:-80, Orto:30, O:40, C:55, E:60, A:45, S:55},
    descP:'Identidade nacional, lei e ordem, valores tradicionais.',
    descG:'Proteção e coesão nacional guiadas por resultados.',
    expP:[
      'Eixos: tradicionalismo (−Cult), autoridade (−Autor), nacionalismo (−Glob).',
      'Filosofia: deveres patrióticos e continuidade cultural.',
      'Políticas: controle migratório, reindustrialização, segurança pública firme.'
    ],
    expG:[
      'Prioriza redução de crime e desemprego.',
      'Protecionismo estratégico com metas.',
      'Revisões periódicas conforme indicadores.'
    ]},
  {code:'B15', name:'Populista Nacional de Esquerda', vec:{Ecom:60, Cult:10, Autor:-30, Glob:-80, Orto:10, O:45, C:55, E:55, A:50, S:55},
    descP:'Soberania econômica, redistribuição e identidade popular.',
    descG:'Foco em emprego, renda e proteção dos vulneráveis.',
    expP:[
      'Eixos: estatismo (+Ecom), leve progressismo (+Cult), nacionalismo (−Glob).',
      'Filosofia: justiça social nacional e autodeterminação.',
      'Políticas: nacionalização seletiva, compras locais, controle de capitais.'
    ],
    expG:[
      'Metas de emprego/renda e avaliação setorial.',
      'Tarifas temporárias com revisão.',
      'Programas antifome e crédito popular.'
    ]},
  {code:'B16', name:'Republicano Cívico', vec:{Ecom:-10, Cult:-10, Autor:20, Glob:10, Orto:20, O:55, C:65, E:55, A:60, S:60},
    descP:'Liberdade como não-dominação; virtudes cívicas e regras constitucionais.',
    descG:'Reformas testadas por redução de corrupção e aumento de engajamento.',
    expP:[
      'Eixos: equilíbrio geral com liberalismo cívico.',
      'Filosofia: república mista, deveres e direitos.',
      'Políticas: transparência, participação e educação cívica.'
    ],
    expG:[
      'Mede accountability e confiança institucional.',
      'Ajusta desenho institucional por evidência.',
      'Foco em imparcialidade do Estado.'
    ]},
  {code:'B17', name:'Tecno-Progressista', vec:{Ecom:-20, Cult:90, Autor:30, Glob:80, Orto:-50, O:85, C:60, E:55, A:55, S:55},
    descP:'Inovação e direitos digitais como princípios; progresso humano.',
    descG:'Governança baseada em evidências e métricas de impacto tecnológico.',
    expP:[
      'Eixos: inovação (−Ecom), progressismo (+Cult), globalismo (+Glob).',
      'Filosofia: ciência, racionalidade pública e direitos.',
      'Políticas: IA ética, pesquisa aberta e inclusão digital.'
    ],
    expG:[
      'Pilotos controlados e auditorias independentes.',
      'Itinerários regulatórios adaptativos.',
      'Critério: benefícios líquidos e mitigação de riscos.'
    ]},
  {code:'B18', name:'Tecno-Estatista', vec:{Ecom:40, Cult:80, Autor:-10, Glob:60, Orto:-40, O:80, C:60, E:50, A:50, S:55},
    descP:'Estado coordenando revoluções tecnológicas para o bem público.',
    descG:'Sandboxes, iteração e auditorias empíricas.',
    expP:[
      'Eixos: estatismo (+Ecom), progressismo (+Cult), globalismo (+Glob).',
      'Filosofia: segurança, equidade e inclusão digital.',
      'Políticas: infraestrutura e dados públicos, regulação preventiva.'
    ],
    expG:[
      'Prototipagem regulatória com metas.',
      'Medições de risco/benefício e fairness.',
      'Ajustes contínuos por evidência.'
    ]},
  {code:'B19', name:'Libertário de Esquerda', vec:{Ecom:-50, Cult:70, Autor:90, Glob:10, Orto:-40, O:80, C:45, E:60, A:65, S:50},
    descP:'Autonomia radical, antiautoritarismo e igualdade em costumes.',
    descG:'Comunidades voluntárias avaliadas pelo empoderamento real.',
    expP:[
      'Eixos: mercado (−Ecom) com forte anti-hierarquia (+Autor), progressismo (+Cult).',
      'Filosofia: não dominação e justiça social voluntária.',
      'Políticas: cooperativas, descriminalização, plataformas abertas.'
    ],
    expG:[
      'Mede emancipação e redução de coerção.',
      'Pilotos comunitários e governança distribuída.',
      'Foco em direitos civis concretos.'
    ]},
  {code:'B20', name:'Anarco-Capitalista', vec:{Ecom:-90, Cult:30, Autor:100, Glob:20, Orto:-60, O:70, C:55, E:60, A:50, S:55},
    descP:'Propriedade privada, contratos e não-agressão como axiomas.',
    descG:'Arranjos policêntricos julgados por eficiência observável.',
    expP:[
      'Eixos: mercado extremo (−Ecom) e anti-Estado (+Autor).',
      'Filosofia: direitos negativos e ordem emergente.',
      'Políticas: privatização ampla, moeda competitiva, arbitragem privada.'
    ],
    expG:[
      'Critérios: segurança, custos e inovação institucional.',
      'Mercados de reputação e seguros.',
      'Comparação entre jurisdições voluntárias.'
    ]},
  {code:'B21', name:'Anarco-Comunal', vec:{Ecom:70, Cult:50, Autor:100, Glob:0, Orto:-30, O:75, C:45, E:60, A:70, S:50},
    descP:'Autogestão, horizontalidade e virtudes comunitárias.',
    descG:'Modelos comunais julgados por bem-estar real.',
    expP:[
      'Eixos: economia comum (+Ecom), antiautoritarismo (+Autor).',
      'Filosofia: ética das virtudes e democracia direta.',
      'Políticas: bens comuns, cooperativas integrais, redes solidárias.'
    ],
    expG:[
      'Indicadores de saúde, educação e coesão.',
      'Escalonamento do que prospera em rede.',
      'Transparência e governança participativa.'
    ]},
  {code:'B22', name:'Centrista Pragmático', vec:{Ecom:0, Cult:0, Autor:0, Glob:0, Orto:-10, O:55, C:60, E:50, A:60, S:60},
    descP:'Centro com princípios: equilíbrio de direitos, deveres e virtudes.',
    descG:'“O que funciona” acima de identidades ideológicas.',
    expP:[
      'Eixos: equilíbrio nos quatro quadrantes políticos.',
      'Filosofia: prudência, gradualismo e pactos.',
      'Políticas: comissões independentes e ajustes incrementais.'
    ],
    expG:[
      'Ciclo piloto-medir-ajustar.',
      'Benchmarking e comparação internacional.',
      'Evita soluções maximalistas.'
    ]},
  {code:'B23', name:'Humanista Secular Universalista', vec:{Ecom:-10, Cult:80, Autor:40, Glob:80, Orto:-90, O:80, C:55, E:50, A:65, S:60},
    descP:'Dignidade humana, direitos universais e cosmopolitismo; racionalismo e ética de princípios.',
    descG:'Humanismo por resultados: maximiza florescimento humano mensurável.',
    expP:[
      'Eixos: leve mercado (−Ecom), progressismo (+Cult), liberdades (+Autor), globalismo (+Glob).',
      'Filosofia: ciência, laicidade e direitos humanos.',
      'Políticas: cooperação global, liberdade de consciência, ciência aberta.'
    ],
    expG:[
      'Critérios: bem-estar, saúde e educação global.',
      'Políticas baseadas em evidências comparadas.',
      'Ajustes por métricas de impacto.'
    ]},
];

// Subtipos: Principista vs Pragmatista

const profileSummaries = {
  B1: {
    P: 'Você combina liberalismo clássico e abertura ao mundo: vê o Estado como árbitro de direitos e contratos, defende mercados concorrenciais e acolhe mudanças culturais. Orientado por princípios, prioriza liberdade individual, igualdade perante a lei e racionalidade pública, desconfiando de paternalismos e protecionismos.',
    G: 'Você valoriza liberdade econômica e direitos civis, mas decide por evidências e balanço de custos e benefícios. Abraça integração internacional e inovação, aceita regulação quando ela corrige falhas comprovadas e prefere reformas iterativas a soluções maximalistas.'
  },
  B2: {
    P: 'Autonomia pessoal e subsidiariedade são centrais: você prefere arranjos voluntários, experimentação local e instituições de proximidade. Acredita no princípio de não agressão e em regras simples que protegem liberdades sem impor hierarquias pesadas.',
    G: 'Você confia na engenhosidade das comunidades e na competição de ideias em pequena escala. Testa, compara e adota o que funciona em bairros e municípios, com regulação leve e mecanismos de reputação e cooperação.'
  },
  B3: {
    P: 'Pró-inovação e pró-direitos, você combina mercado com redes de proteção e progressismo em costumes. Enxerga dignidade e oportunidades como objetivos públicos legítimos, sem sufocar o dinamismo econômico.',
    G: 'Pragmático e aberto, você aposta em crescimento com inclusão via políticas avaliadas por impacto. Defende competição, correção de externalidades e ampliação de oportunidades com experimentação responsável.'
  },
  B4: {
    P: 'Você sustenta bem-estar robusto, direitos civis e integração internacional. Igualdade de oportunidades e progressismo cultural caminham com instituições democráticas fortes e um Estado que promove coesão sem autoritarismo.',
    G: 'Você busca equilíbrio entre qualidade do gasto, tributos e resultados sociais. Prefere metas claras e ajustes com base em dados, mirando sustentabilidade fiscal e redução de desigualdades.'
  },
  B5: {
    P: 'Você enxerga desenvolvimento industrial e coesão nacional como prioridades estratégicas. Valoriza coordenação pública, cadeias produtivas fortes e algum conservadorismo cultural.',
    G: 'Você privilegia instrumentos com metas e métricas: conteúdo local, crédito direcionado, P&D e exportações. Revê incentivos por desempenho, com pragmatismo e visão de longo prazo.'
  },
  B6: {
    P: 'Democracia econômica e participação municipal orientam suas preferências. Você aposta em cooperativas, bens comuns e deliberação local para promover igualdade e solidariedade.',
    G: 'Você trata bairros e cidades como laboratórios de bem-estar. Pilota políticas públicas, mede saúde e educação e escala o que funciona com transparência e participação.'
  },
  B7: {
    P: 'Sustentabilidade e liberdade caminham juntas: você prefere mercados bem desenhados, direitos individuais e inovação verde. Valoriza responsabilidade intergeracional e prudência científica.',
    G: 'Você foca em custo-efetividade ambiental, precificação de externalidades e regulação “smart”. Testa tecnologias limpas e revê regras conforme evidências.'
  },
  B8: {
    P: 'Transição ecológica e justiça climática são norte. O Estado lidera mudanças profundas para reduzir impactos e distribuir custos de modo justo.',
    G: 'Você mantém o rumo verde com pragmatismo. Prioriza mitigação/adaptação com melhor custo-benefício social e monitora impactos sobre emprego e renda.'
  },
  B9: {
    P: 'Você combina apreço por instituições, costumes e virtudes cívicas com liberdades civis e economia de mercado. Favorece reformas prudentes e estabilidade social.',
    G: 'Você preserva tradições e direitos sem rupturas. Adere a reformas calibradas por eficácia, competição e transparência regulatória.'
  },
  B10: {
    P: 'Comunidade, família e deveres recíprocos são centrais. Prefere soluções locais, estabilidade de costumes e políticas que reforcem vínculos e responsabilidades.',
    G: 'Você mede coesão e segurança com indicadores concretos. Investe em capital social, mentoria e programas focados no território.'
  },
  B11: {
    P: 'Você reúne valores cristãos sacramentais com democracia e economia social de mercado. Defende dignidade da pessoa, subsidiariedade e proteção social à família.',
    G: 'Você aplica princípios com prudência: prioriza parcerias público-comunitárias, transparência e resultados sociais sem descuidar da sustentabilidade.'
  },
  B12: {
    P: 'Sua referência é a tradição viva, a vida litúrgica e a formação de caráter. Prefere prudência nas mudanças e políticas que protejam a liberdade religiosa e a paz social.',
    G: 'Você aplica o ethos tradicional com sensatez: caridade eficaz, cooperação quando faz sentido e foco em frutos concretos para as pessoas.'
  },
  B13: {
    P: 'Você crê em uma ordem internacional baseada em regras, alianças e responsabilidade de proteger. Concilia comércio, segurança e valores.',
    G: 'Você favorece intervenções criteriosas, com avaliação de riscos, custos e viabilidade. Prefere coalizões eficazes e metas realistas.'
  },
  B14: {
    P: 'Identidade nacional, lei e ordem e costumes tradicionais formam seu núcleo. Prefere fronteiras firmes, controle migratório e combate ao crime.',
    G: 'Você prioriza resultados: reduzir violência e desemprego, fortalecer indústria e coesão, com revisões periódicas do que não entrega.'
  },
  B15: {
    P: 'Soberania econômica, redistribuição e proteção do trabalho são centrais. O Estado atua para corrigir assimetrias e defender o povo.',
    G: 'Você administra tarifas e compras públicas com prazos e metas. Combate fome e desemprego com instrumentos diretos e revisões por desempenho.'
  },
  B16: {
    P: 'Liberdade como não dominação, virtudes cívicas e constituições firmes guiam suas escolhas. Você combate corrupção e arbitrariedade.',
    G: 'Você mede integridade institucional e engajamento cívico. Aperfeiçoa regras com evidências e comparação entre jurisdições.'
  },
  B17: {
    P: 'Você aposta no progresso humano por ciência e direitos digitais, com ética pública e inclusão. Vê tecnologia como alavanca de liberdade.',
    G: 'Você usa pilotos e auditorias independentes para regular de modo adaptativo. Busca benefícios líquidos e mitigação de riscos.'
  },
  B18: {
    P: 'Você vê o Estado como coordenador de revoluções tecnológicas em nome do interesse público. Previne riscos e promove infraestrutura e dados abertos.',
    G: 'Você opera com sandboxes, metas e iteração. Ajusta regras por evidência e fairness, equilibrando inovação e segurança.'
  },
  B19: {
    P: 'Autonomia radical, igualdade em costumes e anti-hierarquia orientam suas escolhas. Prefere comunidades voluntárias e plataformas abertas.',
    G: 'Você avalia emancipação real: governança distribuída, pilotos comunitários e proteção de direitos civis na prática.'
  },
  B20: {
    P: 'Você defende ordem espontânea baseada em propriedade, contratos e não agressão, com mínima centralização. Vê competição institucional como positiva.',
    G: 'Você julga arranjos policêntricos por segurança, custos e inovação. Prefere reputação, seguros e arbitragem privada.'
  },
  B21: {
    P: 'Autogestão e ajuda mútua são seu norte. Democracia direta, bens comuns e virtudes comunitárias organizam a vida coletiva.',
    G: 'Você testa modelos comunais pelo bem-estar real. Escala o que floresce em rede com transparência e participação.'
  },
  B22: {
    P: 'Você evita extremos e combina direitos, deveres e prudência. Prefere pactos, gradualismo e instituições estáveis.',
    G: 'Você adota a máxima “o que funciona fica”. Usa benchmarking, pilotos e ajustes incrementais em vez de grandes rupturas.'
  },
  B23: {
    P: 'Humanismo secular, ciência aberta e direitos universais guiam sua bússola. Valoriza laicidade, liberdade de consciência e cooperação internacional.',
    G: 'Você maximiza florescimento humano mensurável. Compara políticas globalmente e revê decisões por evidências e impacto.'
  }
};

  
function buildCentroids(){
  const centroids = [];
  for(const b of baseProfiles){
    const p = JSON.parse(JSON.stringify(b.vec));
    p.Epist = 60;  p.Etica = 60;  p.Virt  = 80;
    if(p.Orto > 0) p.Orto = clamp(p.Orto + 10, -100, 100);
    const descP = profileSummaries[b.code]?.P || b.descP || b.desc || '';
    centroids.push({
      code:`${b.code}-P`, base:b.code, name:`${b.name} (Principista)`,
      vec:p, desc:descP, subtype:'P'
    });

    const g = JSON.parse(JSON.stringify(b.vec));
    g.Epist = -60; g.Etica = -60; g.Virt  = 60;
    const descG = profileSummaries[b.code]?.G || b.descG || b.desc || '';
    centroids.push({
      code:`${b.code}-G`, base:b.code, name:`${b.name} (Pragmatista)`,
      vec:g, desc:descG, subtype:'G'
    });
  }
  return centroids;
}
const centroids46 = buildCentroids();

// Distance weights
const weights = {
  Ecom:1, Cult:1, Autor:1, Glob:1, Orto:1,
  Epist:0.7, Etica:0.7, Virt:0.7,
  O:0.4, C:0.4, E:0.4, A:0.4, S:0.4
};

function distance(user, center){
  let sum = 0;
  for(const a of Object.keys(weights)){
    const w = weights[a] || 1;
    const diff = (user[a] ?? 0) - (center[a] ?? 0);
    sum += w * diff * diff;
  }
  return Math.sqrt(sum);
}

function classify(axesNorm){
  const V = {};
  for(const a of Object.keys(weights)){ V[a] = axesNorm[a] ?? 0; }
  let best = null, bestD = Infinity;
  for(const c of centroids46){
    const d = distance(V, c.vec);
    if(d < bestD){ bestD = d; best = c; }
  }
  return {best, bestD};
}

/* ------------------------- Digimon mapping (46) ------------------------ */
const digimonMap = {
  'B1-P': {name:'Chicomon', emoji:'🌐', why:'Sociável e aberto a novas alianças; energia otimista e pró-inovação combinam com cosmopolitismo liberal.'},
  'B1-G': {name:'Choromon', emoji:'⚙️', why:'Pragmático e técnico; foca em eficiência e ajustes finos pró-mercado.'},

  'B2-P': {name:'Zerimon', emoji:'🧭', why:'Espírito livre e cooperativo, valoriza autonomia e laços locais com princípios firmes.'},
  'B2-G': {name:'Paomon', emoji:'🏡', why:'Leal e comunitário, prioriza soluções de proximidade que funcionam no cotidiano.'},

  'B3-P': {name:'Leafmon', emoji:'🌱', why:'Crescimento com cuidado social; progressista e amigável a redes de proteção.'},
  'B3-G': {name:'Puwamon', emoji:'🕊️', why:'Observador e adaptável; calibra políticas com dados e feedbacks rápidos.'},

  'B4-P': {name:'Nyokimon', emoji:'🌸', why:'Abertura e intercâmbio; compromisso com bem-estar universal e integração.'},
  'B4-G': {name:'Pipimon', emoji:'📊', why:'Ajusta rotas por evidência; equilíbrio entre justiça social e sustentabilidade fiscal.'},

  'B5-P': {name:'Tsubumon', emoji:'🪨', why:'Semente robusta: foco em base produtiva e projeto nacional.'},
  'B5-G': {name:'Sunamon', emoji:'🏗️', why:'Constrói do chão; metas industriais e pragmatismo estratégico.'},

  'B6-P': {name:'Yuramon', emoji:'🤝', why:'Brota em comunidade; deliberação e solidariedade locais.'},
  'B6-G': {name:'Pyonmon', emoji:'🔁', why:'Iterativo e leve; pilotos municipais e métricas de bem-estar.'},

  'B7-P': {name:'Cocomon', emoji:'🌿', why:'Mercados verdes e inovação ecológica com direitos individuais.'},
  'B7-G': {name:'Pitchmon', emoji:'💧', why:'Navega fluxos (dados/externalidades) para soluções ambientais eficazes.'},

  'B8-P': {name:'Popomon', emoji:'🌳', why:'Justiça climática e transformação coletiva; crescimento com sobriedade.'},
  'B8-G': {name:'Ketomon', emoji:'🧪', why:'Adaptação técnica: mitigação e transição guiadas por impacto.'},

  'B9-P': {name:'Relemon', emoji:'🦊', why:'Prudente e contido; preserva virtudes e liberdades civis.'},
  'B9-G': {name:'Botamon', emoji:'🔥', why:'Clássico e confiável; testando e ajustando sem rupturas bruscas.'},

  'B10-P': {name:'Tomorimon', emoji:'🏘️', why:'Âncora comunitária: família, vizinhança e ordem social orgânica.'},
  'B10-G': {name:'Pafumon', emoji:'🎗️', why:'Coesão e cuidado; políticas locais guiadas por resultados.'},

  'B11-P': {name:'Curimon', emoji:'🕯️', why:'Disciplina e sentido; fé, dignidade e bem comum.'},
  'B11-G': {name:'YukimiBotamon', emoji:'❄️', why:'Temperança e prudência; mesma direção, com avaliação empírica.'},

  'B12-P': {name:'Mokumon', emoji:'🕊️', why:'Simbologia de incenso: tradição viva, ascese e contemplação.'},
  'B12-G': {name:'Puttimon', emoji:'👼', why:'Misericórdia e prudência pastoral aplicadas à vida pública.'},

  'B13-P': {name:'Keemon', emoji:'🛰️', why:'Vigilância e ordem internacional; responsabilidade de proteger.'},
  'B13-G': {name:'Pupumon', emoji:'🧭', why:'Estabilidade por custo-benefício; pragmatismo estratégico em alianças.'},

  'B14-P': {name:'PetiMeramon', emoji:'🚨', why:'Firmeza e energia combativa: lei, ordem e identidade.'},
  'B14-G': {name:'Bommon', emoji:'🧱', why:'Assertivo e protetor; foco no que reduz crime e desemprego.'},

  'B15-P': {name:'Bombmon', emoji:'💥', why:'Impulso mobilizador por soberania e justiça social.'},
  'B15-G': {name:'Zurumon', emoji:'🧱', why:'Pragmatismo áspero na defesa do povo e do trabalho.'},

  'B16-P': {name:'Yolkmon', emoji:'⚖️', why:'Equilíbrio constitucional; instituições como “ovo” da república.'},
  'B16-G': {name:'Pusumon', emoji:'🧩', why:'Aprimora sistemas com paciência e medição de integridade pública.'},

  'B17-P': {name:'Petitmon', emoji:'🚀', why:'Curioso e inventivo; aposta no progresso humano e direitos digitais.'},
  'B17-G': {name:'Kuramon', emoji:'🧠', why:'Lida com riscos digitais com método e avaliação de impacto.'},

  'B18-P': {name:'Fufumon', emoji:'🏭', why:'Forja tecnologia para o bem público com coordenação estatal.'},
  'B18-G': {name:'Dokimon', emoji:'📜', why:'Audita, documenta e itera políticas tecnológicas.'},

  'B19-P': {name:'Fusamon', emoji:'🔗', why:'Sinergias horizontais e autonomia radical com justiça.'},
  'B19-G': {name:'Puyomon', emoji:'🧪', why:'Experimenta e aprende em redes voluntárias.'},

  'B20-P': {name:'Punimon', emoji:'🏴', why:'Mínimo necessário, anti-centralização e liberdade contratual.'},
  'B20-G': {name:'Cotsucomon', emoji:'📐', why:'Ordem espontânea e regras claras testadas na prática.'},

  'B21-P': {name:'Pururumon', emoji:'🕸️', why:'Tecelão de redes de cooperação e apoio mútuo.'},
  'B21-G': {name:'Sakumon', emoji:'🌼', why:'Floresce quando o bem-estar real aumenta.'},

  'B22-P': {name:'Bubbmon', emoji:'🫧', why:'Prudente e centrado; media interesses e evita extremos.'},
  'B22-G': {name:'Torikaraballmon', emoji:'🍗', why:'Humor e pragmatismo cotidiano: o que funciona fica.'},

  'B23-P': {name:'Chibickmon', emoji:'🌍', why:'Cosmopolitismo gentil, direitos humanos e ciência pública.'},
  'B23-G': {name:'Fukamon', emoji:'🌊', why:'Mergulha em dados e coordenação global por resultados.'},
};

/* ---------------------------- UI: Results ------------------------------ */
const axesGrid = document.getElementById('axesGrid');
const profileBlock = document.getElementById('profileBlock');
const topCurrentsDiv = document.getElementById('topCurrents');
const allCurrentsDiv = document.getElementById('allCurrents');
const resultsCard = document.getElementById('results');

function renderAxisCard(aKey, meta, value, isDir){
  const container = document.createElement('div');
  container.className='axis-card';
  const header = document.createElement('div');
  header.style.display='flex'; header.style.justifyContent='space-between'; header.style.alignItems='center';
  const title = document.createElement('div'); title.className='axis-title'; title.textContent = meta.title;
  const badge = document.createElement('div'); badge.innerHTML = `<span class="tag">${(Math.round(value*10)/10).toFixed(1)}</span>`;
  header.append(title, badge);
  const sub = document.createElement('div'); sub.className='axis-sub'; sub.textContent = meta.desc;

  const bar = document.createElement('div'); bar.className='meter'; bar.style.marginTop='8px';
  const center = document.createElement('div'); center.className='center'; if(!isDir){ center.style.display='none'; }
  const fill = document.createElement('div'); fill.className='fill';
  if(isDir){
    const perc = (value + 100) / 2; // 0..100
    fill.style.width = perc + '%';
    fill.style.background = value>=0 ? 'linear-gradient(90deg,#06b6d4,#22c55e)' : 'linear-gradient(90deg,#ef4444,#f59e0b)';
  }else{
    const perc = value; fill.style.width = perc + '%';
    fill.style.background = 'linear-gradient(90deg,#22c55e,#06b6d4)';
  }
  bar.appendChild(fill); bar.appendChild(center);
  container.append(header, sub, bar);
  return container;
}

function renderExpList(arr){
  const ul = document.createElement('ul'); ul.className='tight';
  (arr||[]).forEach(t=>{ const li=document.createElement('li'); li.innerHTML=t; ul.appendChild(li); });
  return ul;
}

function renderResults(axesNorm, currents, classification){
  profileBlock.innerHTML = '';

  // Título e resumo
  const title = document.createElement('div');
  title.className='result-title';
  title.textContent = classification.best.name;

  const desc = document.createElement('div');
  desc.className='desc';
  desc.textContent = classification.best.desc;

  const meta = document.createElement('div');
  meta.style.marginTop='8px';
  meta.innerHTML = `<span class="tag">Distância: ${Math.round(classification.bestD)}</span>`;

  // Digimon
  const digi = digimonMap[classification.best.code];
  const digimonHeader = document.createElement('h3'); 
  digimonHeader.textContent='Seu Digimon correspondente';
  const digimonRow = document.createElement('div'); 
  if(digi){
    digimonRow.innerHTML = `
      <div class="digimon-badge"><span>${digi.emoji || '✨'}</span><strong>${digi.name}</strong></div>
      <div class="small" style="margin-top:6px">${digi.why || ''}</div>
    `;
  }else{
    digimonRow.innerHTML = `<div class="small">Sem mapeamento de Digimon para este perfil.</div>`;
  }

  // Explicações (expP/expG do perfil base)
  const base = baseProfiles.find(b=>b.code===classification.best.base);
  const expArr = base ? (classification.best.subtype==='P' ? (base.expP||[]) : (base.expG||[])) : [];
  if(expArr.length){
    const expHeader = document.createElement('h3');
    expHeader.textContent = 'Como isso aparece nos seus eixos e preferências';
    const expList = renderExpList(expArr);
    profileBlock.append(title, desc, meta, digimonHeader, digimonRow, expHeader, expList);
  }else{
    profileBlock.append(title, desc, meta, digimonHeader, digimonRow);
  }

  // Eixos
  axesGrid.innerHTML='';
  for(const a of ['Ecom','Cult','Autor','Glob','Epist','Etica','Orto','Virt','O','C','E','A','S']){
    const isDir = axisMeta[a].type==='dir';
    const el = renderAxisCard(a, axisMeta[a], axesNorm[a], isDir);
    axesGrid.appendChild(el);
  }

  // Correntes: top 3 e todas
  const entries = Object.entries(currents).map(([k,v])=>[k, v]).sort((a,b)=>b[1]-a[1]);
  topCurrentsDiv.innerHTML='';
  for(const [k,v] of entries.slice(0,3)){
    const box = document.createElement('div');
    box.className='card'; box.style.border='1px solid #1f2937';
    const inner = document.createElement('div'); inner.className='body';
    inner.innerHTML = `
      <div style="font-weight:700">${currentsMeta[k]} <span class="tag">${(v).toFixed(1)}</span></div>
      <div class="meter" style="margin-top:6px"><div class="fill" style="width:${v}%;background:linear-gradient(90deg,#0ea5e9,#7c3aed)"></div></div>
      <div class="small" style="margin-top:6px">Código: ${k}</div>
    `;
    box.appendChild(inner);
    topCurrentsDiv.appendChild(box);
  }
  allCurrentsDiv.innerHTML='';
  for(const [k,v] of entries){
    const row = renderAxisCard(k, {title:currentsMeta[k], desc:'Pontuação (0→100)'}, v, false);
    allCurrentsDiv.appendChild(row);
  }

  resultsCard.style.display='';
}

  profileBlock.append(title, desc, meta, digimonHeader, digimonRow, expHeader, expList);

  // Axes grid
  axesGrid.innerHTML='';
  for(const a of ['Ecom','Cult','Autor','Glob','Epist','Etica','Orto','Virt','O','C','E','A','S']){
    const isDir = axisMeta[a].type==='dir';
    const el = renderAxisCard(a, axisMeta[a], axesNorm[a], isDir);
    axesGrid.appendChild(el);
  }

  // Correntes: top 3
  const entries = Object.entries(currents).map(([k,v])=>[k, v]);
  entries.sort((a,b)=>b[1]-a[1]);
  topCurrentsDiv.innerHTML='';
  for(const [k,v] of entries.slice(0,3)){
    const box = document.createElement('div');
    box.className='card'; box.style.border='1px solid #1f2937';
    const inner = document.createElement('div'); inner.className='body';
    inner.innerHTML = `
      <div style="font-weight:700">${currentsMeta[k]} <span class="tag">${(v).toFixed(1)}</span></div>
      <div class="meter" style="margin-top:6px"><div class="fill" style="width:${v}%;background:linear-gradient(90deg,#0ea5e9,#7c3aed)"></div></div>
      <div class="small" style="margin-top:6px">Código: ${k}</div>
    `;
    box.appendChild(inner);
    topCurrentsDiv.appendChild(box);
  }
  allCurrentsDiv.innerHTML='';
  for(const [k,v] of entries){
    const row = renderAxisCard(k, {title:currentsMeta[k], desc:'Pontuação (0→100)'}, v, false);
    allCurrentsDiv.appendChild(row);
  }

  resultsCard.style.display='';
}

/* ------------------------------ History -------------------------------- */
const LS_KEY_HISTORY = 'quiz46_history';
const LS_KEY_AUTOSAVE = 'quiz46_autoSave';
const historyList = document.getElementById('historyList');
const historyEmpty = document.getElementById('historyEmpty');

function loadAutoSavePref(){
  const chk = document.getElementById('chkAutoSave');
  let v = localStorage.getItem(LS_KEY_AUTOSAVE);
  // Ativado por padrão
  if(v === null || (v !== '0' && v !== '1')){ v = '1'; localStorage.setItem(LS_KEY_AUTOSAVE, '1'); }
  chk.checked = v === '1';
  chk.addEventListener('change', ()=> localStorage.setItem(LS_KEY_AUTOSAVE, chk.checked?'1':'0'));
}
loadAutoSavePref();

function getHistory(){
  try{
    const raw = localStorage.getItem(LS_KEY_HISTORY);
    if(!raw) return [];
    const arr = JSON.parse(raw);
    if(Array.isArray(arr)) return arr;
    return [];
  }catch(e){ return []; }
}
function setHistory(arr){
  try{ localStorage.setItem(LS_KEY_HISTORY, JSON.stringify(arr)); }catch(e){}
}
function saveToHistory(entry){
  const arr = getHistory();
  arr.unshift(entry);
  setHistory(arr);
  renderHistory();
}
function removeFromHistory(id){
  const arr = getHistory().filter(x=>x.id!==id);
  setHistory(arr);
  renderHistory();
}
function restoreResponses(entry){
  const resp = entry.responses || {};
  for(const it of items){
    const el = document.getElementById(it.code);
    if(el && typeof resp[it.code] !== 'undefined'){
      el.value = String(resp[it.code]);
    }
  }
  window.scrollTo({top:0, behavior:'smooth'});
}
function renderHistory(){
  const arr = getHistory();
  historyList.innerHTML = '';
  historyEmpty.style.display = arr.length ? 'none' : '';
  for(const h of arr){
    const card = document.createElement('div'); card.className='card';
    const body = document.createElement('div'); body.className='body';
    const dt = new Date(h.timestamp);
    const top3 = topCurrents(h.currents, 3).map(t=>`${t.name} (${t.value.toFixed(0)})`).join(', ');
    const digi = digimonMap[h.profile.code] || {};
    body.innerHTML = `
      <div style="display:flex;justify-content:space-between;gap:8px;align-items:center;flex-wrap:wrap">
        <div>
          <div style="font-weight:700">${h.profile.name}</div>
          <div class="small">${dt.toLocaleString()} • Distância: ${Math.round(h.profile.distance)}</div>
          <div class="small">Top correntes: ${top3}</div>
          <div class="small">Digimon: <span class="digimon-badge"><span>${digi.emoji||'✨'}</span><strong>${digi.name||'—'}</strong></span></div>
        </div>
        <div class="actions" style="margin:0">
          <button class="ghost" data-act="restore" data-id="${h.id}">Restaurar respostas</button>
          <button class="ghost" data-act="recalc" data-id="${h.id}">Recalcular</button>
          <button class="secondary" data-act="del" data-id="${h.id}">Excluir</button>
        </div>
      </div>
    `;
    card.appendChild(body);
    historyList.appendChild(card);
  }
  historyList.querySelectorAll('button').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const id = btn.getAttribute('data-id');
      const act = btn.getAttribute('data-act');
      const entry = getHistory().find(x=>x.id===id);
      if(!entry) return;
      if(act==='restore'){ restoreResponses(entry); }
      if(act==='recalc'){
        restoreResponses(entry);
        doCalc();
        window.scrollTo({top:document.getElementById('results').offsetTop-10, behavior:'smooth'});
      }
      if(act==='del'){ removeFromHistory(id); }
    });
  });
}
function topCurrents(currObj, n=3){
  const arr = Object.entries(currObj||{}).map(([k,v])=>({code:k, name:currentsMeta[k], value:v}));
  arr.sort((a,b)=>b.value-a.value);
  return arr.slice(0,n);
}
renderHistory();

/* ------------------------------ Controls ------------------------------ */
document.getElementById('btnCalc').addEventListener('click', ()=> doCalc());
document.getElementById('btnExport').addEventListener('click', ()=>{
  const bundle = buildCurrentBundle();
  if(!bundle) return;
  downloadJSON(bundle.one, 'resultado-46perfils.json');
});
document.getElementById('btnRandom').addEventListener('click', ()=>{
  for(const it of items){ document.getElementById(it.code).value = String(1 + Math.floor(Math.random()*5)); }
});
document.getElementById('btnNeutral').addEventListener('click', ()=>{
  for(const it of items){ document.getElementById(it.code).value = '3'; }
});
document.getElementById('btnSaveHistory').addEventListener('click', ()=>{
  const bundle = buildCurrentBundle();
  if(!bundle) return;
  saveToHistory(bundle.one);
});
document.getElementById('btnExportHistory').addEventListener('click', ()=>{
  const arr = getHistory();
  downloadJSON(arr, 'historico-46perfils.json');
});
document.getElementById('btnClearHistory').addEventListener('click', ()=>{
  if(confirm('Deseja limpar todo o histórico?')){ setHistory([]); renderHistory(); }
});

function doCalc(){
  const bundle = buildCurrentBundle();
  if(!bundle) return;
  renderResults(bundle.axes, bundle.currents, bundle.cls);
  if(document.getElementById('chkAutoSave').checked){
    saveToHistory(bundle.one);
  }
  window.scrollTo({top:document.getElementById('results').offsetTop - 10, behavior:'smooth'});
}
function buildCurrentBundle(){
  const responses = getResponses();
  const {rawAxes, axesNorm, rawCurr, currNorm} = computeScores(responses);
  const cls = classify(axesNorm);
  const one = {
    id: String(Date.now()) + '_' + Math.random().toString(36).slice(2,7),
    responses, axesRaw:rawAxes, axes:axesNorm, currentsRaw:rawCurr, currents:currNorm,
    profile:{code:cls.best.code, name:cls.best.name, subtype:cls.best.subtype, distance:cls.bestD, base:cls.best.base},
    timestamp:new Date().toISOString()
  };
  return {one, axes:axesNorm, currents:currNorm, cls};
}
function downloadJSON(obj, filename){
  const blob = new Blob([JSON.stringify(obj,null,2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
}

  // 1) Tema claro/escuro (persistente)
(function themeToggle(){
  const KEY='quiz46_theme';
  const btn = document.createElement('button');
  btn.id='themeToggle';
  btn.className='ghost';
  btn.style.marginLeft='8px';
  function setTheme(t){ document.documentElement.setAttribute('data-theme', t); localStorage.setItem(KEY,t); btn.textContent = t==='light'?'🌙 Tema':'☀️ Tema'; }
  setTheme(localStorage.getItem(KEY)||'dark');

  // Botão no header
  const hdr = document.querySelector('header');
  const row = document.createElement('div');
  row.style.display='flex'; row.style.justifyContent='space-between'; row.style.alignItems='center'; row.style.gap='8px'; row.style.marginTop='8px';
  const spacer = document.createElement('div'); spacer.textContent='';
  const tools = document.createElement('div'); tools.style.display='flex'; tools.style.gap='8px'; tools.appendChild(btn);
  row.append(spacer, tools);
  hdr.appendChild(row);

  btn.addEventListener('click', ()=> setTheme((localStorage.getItem(KEY)||'dark')==='dark'?'light':'dark'));
})();

// 2) Barra de progresso no header
(function headerProgress(){
  const bar = document.createElement('div');
  bar.className='header-progress';
  bar.innerHTML = '<div class="fill" id="overallProgressFill"></div>';
  document.querySelector('header').appendChild(bar);
})();

// 3) Ferramentas por seção (colapsar, reset, progresso)
(function sectionTools(){
  const cards = Array.from(document.querySelectorAll('#questions .card'));
  cards.forEach(card=>{
    const h2 = card.querySelector('h2');
    const body = card.querySelector('.body');
    if(!h2 || !body) return;

    // Decoração do título
    const titleTxt = h2.textContent.trim();
    h2.textContent='';
    const left = document.createElement('div'); left.textContent = titleTxt;
    const right = document.createElement('div'); right.className='section-tools';
    right.innerHTML = `
      <span class="chip"><span class="mini">Respondidas:</span> <strong class="gprog">0</strong>/12</span>
      <span class="chev">▾</span>
      <button class="ghost" title="Resetar este grupo">Resetar</button>
    `;
    h2.append(left, right);

    // Estado colapsado
    const KEY='quiz46_collapsed';
    const state = JSON.parse(localStorage.getItem(KEY)||'{}');
    if(state[titleTxt]) card.classList.add('collapsed');
    h2.addEventListener('click', (e)=>{
      if(e.target.tagName==='BUTTON') return; // botão reset não colapsa
      card.classList.toggle('collapsed');
      const st = JSON.parse(localStorage.getItem(KEY)||'{}');
      st[titleTxt] = card.classList.contains('collapsed');
      localStorage.setItem(KEY, JSON.stringify(st));
    });

    // Reset do grupo
    right.querySelector('button').addEventListener('click', (e)=>{
      e.stopPropagation();
      body.querySelectorAll('input[type=range]').forEach(r=>{ r.value='3'; r.dispatchEvent(new Event('input',{bubbles:true})) });
      updateProgress();
    });
  });
})();

// 4) Sliders com bolha de valor e atalhos
(function enhanceSliders(){
  const sliders = Array.from(document.querySelectorAll('#questions input[type=range]'));

  function labelOf(v){
    const map = {1:'1',2:'2',3:'3',4:'4',5:'5'};
    return map[v] || String(v);
  }
  function positionBubble(input){
    let bubble = input.parentElement.querySelector('.value-bubble');
    if(!bubble){
      bubble = document.createElement('div'); bubble.className='value-bubble';
      input.parentElement.appendChild(bubble);
    }
    const v = Number(input.value);
    const perc = (v-1)/4*100;
    bubble.textContent = labelOf(v);
    bubble.style.left = perc+'%';
  }

  sliders.forEach((s, idx)=>{
    // bolha dinâmica
    s.addEventListener('input', ()=> positionBubble(s));
    s.addEventListener('focus', ()=> positionBubble(s));

    // atalhos 1..5 / setas / J K
    s.addEventListener('keydown', (e)=>{
      if(/^[1-5]$/.test(e.key)){ s.value = e.key; s.dispatchEvent(new Event('input',{bubbles:true})); e.preventDefault(); }
      if(e.key==='ArrowRight' || e.key==='ArrowUp'){ s.value = Math.min(5, Number(s.value)+1); s.dispatchEvent(new Event('input',{bubbles:true})); e.preventDefault(); }
      if(e.key==='ArrowLeft'  || e.key==='ArrowDown'){ s.value = Math.max(1, Number(s.value)-1); s.dispatchEvent(new Event('input',{bubbles:true})); e.preventDefault(); }
      if(e.key.toLowerCase()==='j'){ focusNext(idx,+1); e.preventDefault(); }
      if(e.key.toLowerCase()==='k'){ focusNext(idx,-1); e.preventDefault(); }
      if(e.key==='Enter' && (e.ctrlKey||e.metaKey)){ doCalc(); }
    });
  });

  function focusNext(i, dir){
    const arr = Array.from(document.querySelectorAll('#questions input[type=range]'));
    const j = Math.max(0, Math.min(arr.length-1, i+dir));
    arr[j].focus({preventScroll:false}); arr[j].scrollIntoView({behavior:'smooth', block:'center'});
  }
})();

// 5) Pré-visualização ao vivo (sem salvar no histórico)
(function livePreview(){
  const debounced = debounce(()=> {
    const responses = getResponses();
    const {axesNorm, currNorm} = computeScores(responses);
    const cls = classify(axesNorm);
    renderResults(axesNorm, currNorm, cls); // só renderiza, sem salvar
  }, 180);

  document.querySelectorAll('#questions input[type=range]').forEach(r=>{
    r.addEventListener('input', ()=> { debounced(); updateProgress(); });
  });

  // atalhos globais
  document.addEventListener('keydown', (e)=>{
    if((e.ctrlKey||e.metaKey) && e.key==='Enter'){ doCalc(); }
    if(e.key.toLowerCase()==='n'){ scrollToNextNeutral(); }
  });
})();

// 6) Sticky bar com ações rápidas (calcular, salvar, próxima neutra, topo, tema)
(function stickyBar(){
  const bar = document.createElement('div');
  bar.id='stickyBar';
  bar.innerHTML = `
    <div class="wrap">
      <div class="left">
        <button id="sbCalc">Calcular</button>
        <button id="sbSave" class="secondary">Salvar</button>
        <button id="sbNext" class="ghost" title="Ir para a próxima pergunta neutra (N)">Próx. neutra</button>
      </div>
      <div class="right">
        <span class="hint" id="sbProg">Progresso: 0%</span>
        <button id="sbTop" class="ghost">Topo</button>
        <button id="sbTheme" class="ghost" title="Alternar tema">Tema</button>
      </div>
    </div>
  `;
  document.body.appendChild(bar);

  document.getElementById('sbCalc').addEventListener('click', ()=> doCalc());
  document.getElementById('sbSave').addEventListener('click', ()=>{
    const bundle = buildCurrentBundle(); if(!bundle) return; saveToHistory(bundle.one);
  });
  document.getElementById('sbNext').addEventListener('click', scrollToNextNeutral);
  document.getElementById('sbTop').addEventListener('click', ()=> window.scrollTo({top:0, behavior:'smooth'}));
  document.getElementById('sbTheme').addEventListener('click', ()=>{
    const cur = document.documentElement.getAttribute('data-theme')||'dark';
    const next = cur==='dark'?'light':'dark';
    document.getElementById('themeToggle')?.click(); // aproveita o botão já criado
  });
})();

// 7) Progresso (geral e por grupo) + utilidades
function updateProgress(){
  const sliders = Array.from(document.querySelectorAll('#questions input[type=range]'));
  const answered = sliders.filter(s=>s.value!=='3').length;
  const total = sliders.length || 1;
  const pct = Math.round(answered/total*100);
  const fill = document.getElementById('overallProgressFill'); if(fill) fill.style.width = pct+'%';
  const sb = document.getElementById('sbProg'); if(sb) sb.textContent = `Progresso: ${pct}%`;

  // Por grupo (12 por seção)
  const cards = Array.from(document.querySelectorAll('#questions .card'));
  cards.forEach(card=>{
    const n = card.querySelectorAll('input[type=range]').length || 1;
    const a = Array.from(card.querySelectorAll('input[type=range]')).filter(s=>s.value!=='3').length;
    const g = card.querySelector('.gprog'); if(g) g.textContent = a;
  });
}
function scrollToNextNeutral(){
  const neutral = Array.from(document.querySelectorAll('#questions input[type=range]')).find(s=>s.value==='3');
  if(neutral){
    neutral.scrollIntoView({behavior:'smooth', block:'center'});
    neutral.classList.add('pulse'); setTimeout(()=>neutral.classList.remove('pulse'), 1000);
    neutral.focus({preventScroll:true});
  }
}
function debounce(fn, wait){
  let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), wait); }
}

// Inicializar progresso ao carregar
updateProgress();
</script>
</body>
</html>
